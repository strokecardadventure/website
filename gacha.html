<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="manifest" href="manifest.webmanifest"><meta name="theme-color" content="#e11d48">
<link rel="icon" href="assets/icons/pwa-192.png">
<link rel="stylesheet" href="css/global.css?v=10"><title>Gacha</title></head>
<body>
<header class="header"><button class="icon-btn" onclick="toggleSidebar()">â˜°</button><h1 class="title">Gacha</h1><span class="icon-btn">ðŸŽ²</span></header>
<aside class="sidebar"><div class="brand"><img src="assets/icons/pwa-192.png"><strong>Stroke Card Adventure</strong></div>
  <nav class="menu">
    <a id="m-play" href="play.html">Play</a><a id="m-cards" href="my-cards.html">My cards</a><a id="m-mission" href="mission.html">Mission</a>
    <a id="m-gacha" class="active" href="gacha.html">Gacha</a><a id="m-profile" href="profile.html">Profile</a><a id="m-comment" href="comment.html">Comment</a>
  </nav><button class="btn" onclick="logout()">Logout</button></aside>
<div class="backdrop" onclick="toggleSidebar()"></div>

<main id="app" class="content"></main>

<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
<script src="js/firebase.js"></script><script src="js/ui.js"></script><script src="js/cards.js"></script>
<script>
requireAuth().then(async ()=>{
  const u = await getUserDoc(); const have=new Set(u.unlocked||[]);
  const unowned = CARDS.map(c=>c.id).filter(id=>![...have].some(x=>baseOf(x)===id));
  const cost=5; // coins
  app.innerHTML = `<div class="tile">Coins: ${u.coins||0}</div>
    <button class="btn primary" id="roll" ${ (u.coins||0)<cost?'disabled':'' }>Roll (-${cost} coins)</button>
    <div class="muted">Random unlock from unowned base cards.</div>`;
  document.getElementById('roll').onclick = async ()=>{
    const doc = await getUserDoc(); if((doc.coins||0)<cost) return toast('Not enough coins');
    const pool = CARDS.map(c=>c.id).filter(id=>![...(doc.unlocked||[])].some(x=>baseOf(x)===id));
    if(!pool.length) return toast('All owned!');
    const pick = pool[Math.floor(Math.random()*pool.length)];
    await userRef().update({ coins:(doc.coins||0)-cost }); await unlockCard(pick);
    toast('Unlocked: '+pick); location.reload();
  };
});
</script>
</body></html>
